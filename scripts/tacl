#!/bin/bash

if [[ $# -lt 1 ]]; then
    echo ""
    echo "  Missing arguments, exiting"
    echo "  tacl --help <admin,data> for help"
    echo "  tacl --guide <admin,data> for a longer explanation"
    echo ""
    exit 1
fi

collect_credentials() {
    read -p 'User > ' USERNAME
    read -s -p 'Password > ' PASSWORD; echo
    read -p 'OTP > ' OTP
}

recipient='l.c.d.toit@usit.uio.no' # TODO get from config

exit_if_is_directory() {
    if [[ -d $1 ]]; then
        echo 'Input data is a directory'
        echo 'This method handles files only'
        exit 1
    fi
}

import_data() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            --env)      shift; API_ENV=$1; shift ;;
            --config)   shift; CONF=$1; shift ;;
            --pnum)     shift; PNUM=$1; shift ;;
            --pre)      shift; PRE=$1; shift ;;
            --post)     shift; POST=$1; shift ;;
            --data)     shift; INPUT_DATA=$1; shift ;;
            *)          shift ;;
        esac
    done
    if [[ $POST == '' ]]; then
        POST='none'
    fi

    # Files
    # -----

    if [[ $PRE == '' ]]; then
        echo 'POST without pre-processing'
        exit_if_is_directory $INPUT_DATA
        tacl_data --env $API_ENV --pnum $PNUM \
            --config $CONF --data $INPUT_DATA \
            --user_name $USERNAME --password $PASSWORD --otp $OTP
        exit 0
    elif [[ $PRE == 'compress' ]]; then
        exit_if_is_directory $INPUT_DATA
        gzip -9 < $INPUT_DATA |
        tacl_data \
            --env $API_ENV --pnum $PNUM \
            --config $CONF --post $POST --data $INPUT_DATA \
            --user_name $USERNAME --password $PASSWORD --otp $OTP -
        exit 0
    elif [[ $PRE == 'encrypt' ]]; then
        echo 'POST with encryption'
        exit_if_is_directory $INPUT_DATA
        PW=$(openssl rand -base64 10)
        ENCPW=$(echo $PW | gpg -r $recipient --encrypt | openssl base64 -A)
        openssl enc -aes-256-cbc -in $INPUT_DATA -a -pass file:<( echo $PW ) |
        tacl_data \
            --encryptedpw $ENCPW --env $API_ENV --pnum $PNUM \
            --config $CONF --post $POST --data $INPUT_DATA \
            --user_name $USERNAME --password $PASSWORD --otp $OTP -
        exit 0
    elif [[ $PRE == *"compress"* ]] && [[ $PRE == *"encrypt"* ]]; then
        echo 'POST with compression and encryption'
        exit_if_is_directory $INPUT_DATA
        PW=$(openssl rand -base64 10)
        ENCPW=$(echo $PW | gpg -r $recipient --encrypt | openssl base64 -A)
        gzip -9 < $INPUT_DATA |
        openssl enc -aes-256-cbc -in $INPUT_DATA -a -pass file:<( echo $PW ) |
        tacl_data \
            --encryptedpw $ENCPW --env $API_ENV --pnum $PNUM \
            --config $CONF --post $POST --data $INPUT_DATA \
            --user_name $USERNAME --password $PASSWORD --otp $OTP -
        exit 0

    # Directories
    # -----------

    elif [[ $PRE == 'archive' ]]; then
        echo 'POST with tar'
        tar -cf - $INPUT_DATA |
        tacl_data \
            --env $API_ENV --pnum $PNUM \
            --config $CONF --post $POST --data $INPUT_DATA \
            --user_name $USERNAME --password $PASSWORD --otp $OTP -
        exit 0
    elif [[ $PRE == *"archive"* ]] && [[ $PRE == *"compress"* ]] && [[ $PRE == *"encrypt"* ]]; then
        echo 'POST with tar, compress, and encrypt'
        PW=$(openssl rand -base64 10)
        ENCPW=$(echo $PW | gpg -r $recipient --encrypt | openssl base64 -A)
        tar -cf - $INPUT_DATA |
        gzip -9 |
        openssl enc -aes-256-cbc -a -pass file:<( echo $PW ) |
        tacl_data \
            --encryptedpw $ENCPW \
            --env $API_ENV --pnum $PNUM \
            --config $CONF --post $POST --data $INPUT_DATA \
            --user_name $USERNAME --password $PASSWORD --otp $OTP -
        exit 0
    elif [[ $PRE == *"archive"* ]] && [[ $PRE == *"encrypt"* ]]; then
        echo 'POST with tar and encrypt'
        PW=$(openssl rand -base64 10)
        ENCPW=$(echo $PW | gpg -r $recipient --encrypt | openssl base64 -A)
        tar -cf - $INPUT_DATA |
        openssl enc -aes-256-cbc -a -pass file:<( echo $PW ) |
        tacl_data \
            --encryptedpw $ENCPW \
            --env $API_ENV --pnum $PNUM \
            --config $CONF --post $POST --data $INPUT_DATA \
            --user_name $USERNAME --password $PASSWORD --otp $OTP -
        exit 0
    elif [[ $PRE == *"archive"* ]] && [[ $PRE == *"compress"* ]]; then
        echo 'POST with tar and gzip'
        tar -cf - $INPUT_DATA | gzip -9 |
        tacl_data \
            --env $API_ENV --pnum $PNUM \
            --config $CONF --post $POST --data $INPUT_DATA \
            --user_name $USERNAME --password $PASSWORD --otp $OTP -
        exit 0
    fi
}

if [[ $1 =~ ^('--help'|'--guide') ]]; then
    if [[ $2 == 'admin' ]]; then
        tacl_admin $1
        exit 0
    elif [[ $2 == 'data' ]]; then
        tacl_data $1
        exit 0
    fi
fi

args=("$@")
for i in ${args[*]}; do
    if [[ $i =~ ^('--signup'|'--confirm'|'--getapikey'|'--delapikey'|'--pwreset') ]]; then
        tacl_admin $@
        exit 0
    elif [[ $i == '--data' ]]; then
        collect_credentials
        import_data $@
        exit 0
    fi
done
