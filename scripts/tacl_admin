#!/bin env python

"""API client for admin."""

import click

from tsdapiclient.administrator import do_signup, do_confirm, \
        get_api_key, del_api_key, pw_reset
from tsdapiclient.config import ENV
from tsdapiclient.configurer import read_config, update_config
from tsdapiclient.tools import _check_present


def print_admin_guide():
    guide_text = """\

        TSD API client command-line tool: tacl
        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

        Usage: tacl [OPTIONS]

        Registration
        ~~~~~~~~~~~~

        Suppose you want to register for p11 in test:

        tacl --pnum p11 --signup --client_name '<name>' --email '<email>'
        # returns a client_id
        # get your confirmation token in email
        # save this in a config file:
        # client_id: '<id>'
        # confirmation_token: '<token>'

        tacl --pnum p11 --config <file> --confirm
        # returns a password
        # ask for your client to be verified
        # add this to the config file
        # pass: '<pw>'

        tacl --pnum p11 --config <file> --getapikey
        # returns an API key
        # save this in the config file
        # api_key: <key>

        Management
        ~~~~~~~~~~
        tacl --pnum p11 --config <file> --delapikey '<key>'
        tacl --pnum p11 --config <file> --pwreset

        API docs
        ~~~~~~~~
        test.api.tsd.usit.no/v1/docs/tsd-api-integration.html

    """
    print guide_text


@click.command()
@click.option('--env', default='test', help='which environment you want to interact with')
@click.option('--pnum', default=None, help='project numbers')
@click.option('--signup', is_flag=True, default=False, help='register an API client')
@click.option('--confirm', is_flag=True, default=False, help='confirm your details')
@click.option('--getapikey', is_flag=True, default=False, help='get a persistent API key')
@click.option('--delapikey', default=False, help='revoke an API key')
@click.option('--pwreset', is_flag=True, default=False, help='reset your password')
@click.option('--guide', is_flag=True, default=False, help='print help text')
@click.option('--client_name', default=None, help='your client\'s name')
@click.option('--email', default=None, help='your email address')
def main(env, pnum, signup, confirm, getapikey, delapikey, pwreset, guide,
         client_name, email):
    if guide:
        print_admin_guide()
        return
    # TODO: set prod as default
    if env not in ['test', 'prod']:
        print 'unknown env'
        sys.exit(1)
    _check_present(env, 'env')
    _check_present(pnum, 'pnum')
    tacl_config = {'test': {}, 'prod': {}}
    if signup:
        _check_present(client_name, 'client_name')
        _check_present(email, 'email')
        resp = do_signup(env, pnum, client_name, email)
        print resp
        update_config(env, 'client_name', client_name)
        update_config(env, 'email', email)
        # TODO: pick client_id out and update config
        return
    if confirm:
        _check_present(client_id, 'client_id')
        conf = read_config()[env]
        resp = do_confirm(env, pnum, conf['client_id'], conf['confirmation_token'])
        print resp
        # TODO: pick out pass, store in config
        return
    if getapikey:
        conf = read_config()[env]
        resp = get_api_key(env, pnum, conf['client_id'], conf['pass'])
        print resp
        # TODO: store key in config
        return
    if delapikey:
        conf = read_config()[env]
        resp = del_api_key(env, pnum, conf['client_id'], conf['pass'], delapikey)
        print resp
        # TODO: store new key
        return
    if pwreset:
        conf = read_config()[env]
        resp = pw_reset(env, pnum, conf['client_id'], conf['pass'])
        print resp
        # TODO: store new pw
        return


if __name__ == '__main__':
    main()
